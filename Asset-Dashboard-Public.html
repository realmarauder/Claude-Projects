<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: #a0a0a0;
            font-size: 1.1rem;
        }

        .section-heading {
            font-size: 2rem;
            font-weight: 600;
            color: #ffffff;
            margin: 40px 0 25px 0;
            text-align: center;
            position: relative;
        }

        .section-heading::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .section-heading:first-of-type {
            margin-top: 20px;
        }

        .last-updated {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .crypto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .crypto-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .crypto-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .crypto-card:hover::before {
            opacity: 1;
        }

        .crypto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .crypto-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .crypto-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .btc { background: linear-gradient(135deg, #f7931a, #ff6b35); }
        .eth { background: linear-gradient(135deg, #627eea, #4169e1); }
        .sol { background: linear-gradient(135deg, #14f195, #9945ff); }
        .doge { background: linear-gradient(135deg, #c2a633, #f4d03f); }
        .xrp { background: linear-gradient(135deg, #23292f, #0085c3); }
        .zec { background: linear-gradient(135deg, #231f20, #f4b728); }
        
        /* Static Assets */
        .treasury { background: linear-gradient(135deg, #2c3e50, #3498db); }
        
        /* Dynamic Stock Gradients */
        .stock-default { background: linear-gradient(135deg, #34495e, #5f6a6a); }
        .stock-1 { background: linear-gradient(135deg, #e31837, #cc1338); }
        .stock-2 { background: linear-gradient(135deg, #34495e, #2c3e50); }
        .stock-3 { background: linear-gradient(135deg, #003478, #0066cc); }
        .stock-4 { background: linear-gradient(135deg, #4b0082, #663399); }
        .stock-5 { background: linear-gradient(135deg, #8b0000, #dc143c); }
        .stock-6 { background: linear-gradient(135deg, #228b22, #32cd32); }
        .stock-7 { background: linear-gradient(135deg, #ff6347, #ff4500); }
        .stock-8 { background: linear-gradient(135deg, #4682b4, #5f9ea0); }
        .stock-9 { background: linear-gradient(135deg, #800080, #9932cc); }
        .stock-10 { background: linear-gradient(135deg, #ff8c00, #ffa500); }

        .crypto-info h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .crypto-info .symbol {
            color: #a0a0a0;
            font-size: 0.9rem;
        }

        .crypto-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .data-item {
            display: flex;
            flex-direction: column;
        }

        .data-label {
            color: #a0a0a0;
            font-size: 0.8rem;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .price {
            font-size: 1.5rem !important;
            font-weight: 700;
        }

        .positive {
            color: #00ff88;
        }

        .negative {
            color: #ff4757;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0a0a0;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            color: #ff4757;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        /* Dynamic Stock Management Styles */
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: rgba(255, 71, 87, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
        }

        .crypto-card:hover .remove-btn {
            display: flex;
        }

        .remove-btn:hover {
            background: rgba(255, 71, 87, 1);
            transform: scale(1.1);
        }

        .add-stock-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .add-stock-container:hover {
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .add-stock-container.expanded {
            cursor: default;
        }

        .add-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .add-stock-form {
            display: none;
            flex-direction: column;
            width: 100%;
            gap: 15px;
        }

        .add-stock-form.visible {
            display: flex;
        }

        .stock-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 12px 15px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .stock-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .stock-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .stock-preview {
            display: none;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .stock-preview.visible {
            display: block;
        }

        .stock-result {
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stock-result:last-child {
            border-bottom: none;
        }

        .stock-result:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .stock-result.selected {
            background: rgba(102, 126, 234, 0.3);
        }

        .stock-result-symbol {
            font-weight: 600;
            color: #667eea;
        }

        .stock-result-name {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin-top: 2px;
        }

        .no-results {
            padding: 12px;
            color: #ff4757;
            text-align: center;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .confirmation-modal.visible {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #ff4757;
        }

        .modal-content p {
            margin-bottom: 25px;
            color: #a0a0a0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .crypto-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 0 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Asset Dashboard</h1>
            <p>Real-time crypto and stock prices, volumes, and network data</p>
        </div>
        
        <div class="last-updated" id="lastUpdated">
            Loading data...
        </div>

        <h2 class="section-heading">Cryptocurrency</h2>
        <div class="crypto-grid" id="cryptoGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Fetching cryptocurrency data...</p>
            </div>
        </div>

        <h2 class="section-heading">Market Assets</h2>
        <div class="crypto-grid" id="assetsGrid">
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="modal-content">
            <h3>Remove Stock</h3>
            <p id="confirmationText">Are you sure you want to remove this stock from your dashboard?</p>
            <div class="form-buttons">
                <button class="btn btn-secondary" onclick="closeConfirmationModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmRemoveBtn">Remove</button>
            </div>
        </div>
    </div>

    <script>
        const cryptos = [
            { id: 'bitcoin', symbol: 'BTC', name: 'Bitcoin', class: 'btc' },
            { id: 'ethereum', symbol: 'ETH', name: 'Ethereum', class: 'eth' },
            { id: 'solana', symbol: 'SOL', name: 'Solana', class: 'sol' },
            { id: 'dogecoin', symbol: 'DOGE', name: 'Dogecoin', class: 'doge' },
            { id: 'ripple', symbol: 'XRP', name: 'XRP', class: 'xrp' },
            { id: 'zcash', symbol: 'ZEC', name: 'Zcash', class: 'zec' }
        ];

        // Static treasury asset
        const treasuryAsset = { id: 'treasury-10y', symbol: 'TNX', name: '10-Year Treasury', class: 'treasury', type: 'bond' };

        // Default stocks
        const defaultStocks = [
            { symbol: 'TSLA', name: 'Tesla Inc.' },
            { symbol: 'TMC', name: 'The Metals Company' },
            { symbol: 'F', name: 'Ford Motor Co.' },
            { symbol: 'FDX', name: 'FedEx Corporation' },
            { symbol: 'LMT', name: 'Lockheed Martin' },
            { symbol: 'PMT', name: 'PennyMac Mortgage' },
            { symbol: 'FNMA', name: 'Fannie Mae' },
            { symbol: 'FMCC', name: 'Freddie Mac' }
        ];

        // Dynamic stocks management
        let userStocks = [];
        let stockGradientIndex = 1;
        const apiKey = 'Get your own API Key from finnhub.io';

        function loadUserStocks() {
            const saved = localStorage.getItem('userStocks');
            if (saved) {
                userStocks = JSON.parse(saved);
            } else {
                // First time - load defaults
                userStocks = defaultStocks.map((stock, index) => ({
                    ...stock,
                    id: stock.symbol.toLowerCase(),
                    class: `stock-${(index % 10) + 1}`,
                    type: 'stock'
                }));
                saveUserStocks();
            }
        }

        function saveUserStocks() {
            localStorage.setItem('userStocks', JSON.stringify(userStocks));
        }

        function getNextStockClass() {
            stockGradientIndex = (stockGradientIndex % 10) + 1;
            return `stock-${stockGradientIndex}`;
        }

        async function searchStock(query) {
            try {
                const response = await fetch(`https://finnhub.io/api/v1/search?q=${encodeURIComponent(query)}&token=${apiKey}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.result && data.result.length > 0) {
                        // Return multiple matches, filtered for common stock types
                        return data.result
                            .filter(match => match.type === 'Common Stock' || match.type === 'ETP' || !match.type)
                            .slice(0, 5) // Limit to 5 results
                            .map(match => ({
                                symbol: match.symbol,
                                name: match.description,
                                type: match.type || 'Stock'
                            }));
                    }
                }
                return [];
            } catch (error) {
                console.error('Error searching stock:', error);
                return [];
            }
        }

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        function formatPrice(price) {
            if (price >= 1) return '$' + price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return '$' + price.toFixed(6);
        }

        function getChangeClass(change) {
            return change >= 0 ? 'positive' : 'negative';
        }

        function createCryptoCard(crypto, data) {
            const change24h = data.price_change_percentage_24h || 0;
            const changeClass = getChangeClass(change24h);
            const changeSymbol = change24h >= 0 ? '+' : '';
            
            return `
                <div class="crypto-card">
                    <div class="crypto-header">
                        <div class="crypto-icon ${crypto.class}">${crypto.symbol}</div>
                        <div class="crypto-info">
                            <h3>${crypto.name}</h3>
                            <div class="symbol">${crypto.symbol}</div>
                        </div>
                    </div>
                    <div class="crypto-data">
                        <div class="data-item">
                            <div class="data-label">Price</div>
                            <div class="data-value price">${formatPrice(data.current_price || 0)}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">24h Change</div>
                            <div class="data-value ${changeClass}">${changeSymbol}${change24h.toFixed(2)}%</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Volume (24h)</div>
                            <div class="data-value">$${formatNumber(data.total_volume || 0)}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Market Cap</div>
                            <div class="data-value">$${formatNumber(data.market_cap || 0)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createAssetCard(asset, data, removable = false) {
            const change24h = data.price_change_percentage_24h || 0;
            const changeClass = getChangeClass(change24h);
            const changeSymbol = change24h >= 0 ? '+' : '';
            
            // Customize labels based on asset type
            const thirdLabel = asset.type === 'bond' ? 'Interest Rate' : 'Day High';
            const thirdValue = asset.type === 'bond' ? `${(data.current_price || 0).toFixed(3)}%` : formatPrice(data.day_high || 0);
            const fourthLabel = asset.type === 'bond' ? 'Maturity' : 'Day Low';
            const fourthValue = asset.type === 'bond' ? '10 Years' : formatPrice(data.day_low || 0);
            const priceLabel = asset.type === 'bond' ? 'Yield' : 'Price';
            const priceValue = asset.type === 'bond' ? `${(data.current_price || 0).toFixed(3)}%` : formatPrice(data.current_price || 0);
            
            const removeBtn = removable ? `<button class="remove-btn" onclick="showRemoveConfirmation('${asset.symbol}', '${asset.name}')">×</button>` : '';
            
            return `
                <div class="crypto-card" data-symbol="${asset.symbol}">
                    ${removeBtn}
                    <div class="crypto-header">
                        <div class="crypto-icon ${asset.class}">${asset.symbol}</div>
                        <div class="crypto-info">
                            <h3>${asset.name}</h3>
                            <div class="symbol">${asset.symbol}</div>
                        </div>
                    </div>
                    <div class="crypto-data">
                        <div class="data-item">
                            <div class="data-label">${priceLabel}</div>
                            <div class="data-value price">${priceValue}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">24h Change</div>
                            <div class="data-value ${changeClass}">${changeSymbol}${change24h.toFixed(2)}%</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">${thirdLabel}</div>
                            <div class="data-value">${thirdValue}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">${fourthLabel}</div>
                            <div class="data-value">${fourthValue}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createAddStockCard() {
            return `
                <div class="add-stock-container" onclick="toggleAddForm()">
                    <button class="add-btn">+</button>
                    <p style="color: #a0a0a0; margin: 0;">Add Stock</p>
                    
                    <div class="add-stock-form" id="addStockForm">
                        <input type="text" class="stock-input" id="stockInput" placeholder="Enter company name or ticker symbol" onkeyup="handleStockInput(event)">
                        <div class="stock-preview" id="stockPreview"></div>
                        <div class="form-buttons">
                            <button class="btn btn-secondary" onclick="cancelAddStock()">Cancel</button>
                            <button class="btn btn-primary" id="addStockBtn" onclick="addStock()" disabled>Add Stock</button>
                        </div>
                    </div>
                </div>
            `;
        }

        let currentStockData = null;
        let addFormVisible = false;
        let searchResults = [];
        let selectedResultIndex = -1;

        function toggleAddForm() {
            if (addFormVisible) return;
            
            const form = document.getElementById('addStockForm');
            const container = document.querySelector('.add-stock-container');
            
            form.classList.add('visible');
            container.classList.add('expanded');
            container.onclick = null;
            addFormVisible = true;
            
            // Reset form state
            resetAddForm();
            
            setTimeout(() => {
                document.getElementById('stockInput').focus();
            }, 100);
        }

        function resetAddForm() {
            const preview = document.getElementById('stockPreview');
            const input = document.getElementById('stockInput');
            const addBtn = document.getElementById('addStockBtn');
            
            input.value = '';
            preview.classList.remove('visible');
            preview.innerHTML = '';
            addBtn.disabled = true;
            currentStockData = null;
            searchResults = [];
            selectedResultIndex = -1;
        }

        function cancelAddStock() {
            const form = document.getElementById('addStockForm');
            const container = document.querySelector('.add-stock-container');
            
            form.classList.remove('visible');
            container.classList.remove('expanded');
            container.onclick = toggleAddForm;
            addFormVisible = false;
            
            resetAddForm();
        }

        async function handleStockInput(event) {
            const query = event.target.value.trim();
            const preview = document.getElementById('stockPreview');
            const addBtn = document.getElementById('addStockBtn');
            
            // Handle keyboard navigation
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (selectedResultIndex < searchResults.length - 1) {
                    selectedResultIndex++;
                    updateResultSelection();
                }
                return;
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (selectedResultIndex > 0) {
                    selectedResultIndex--;
                    updateResultSelection();
                }
                return;
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (selectedResultIndex >= 0 && searchResults[selectedResultIndex]) {
                    selectStock(searchResults[selectedResultIndex]);
                } else if (currentStockData) {
                    addStock();
                }
                return;
            }
            
            if (query.length < 1) {
                preview.classList.remove('visible');
                addBtn.disabled = true;
                currentStockData = null;
                searchResults = [];
                selectedResultIndex = -1;
                return;
            }
            
            // Debounce search
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(async () => {
                const stockDataArray = await searchStock(query);
                searchResults = stockDataArray;
                selectedResultIndex = -1;
                
                if (searchResults.length > 0) {
                    displaySearchResults();
                } else {
                    preview.innerHTML = '<div class="no-results">No matching stocks found</div>';
                    preview.classList.add('visible');
                    addBtn.disabled = true;
                    currentStockData = null;
                }
            }, 300);
        }

        function displaySearchResults() {
            const preview = document.getElementById('stockPreview');
            let html = '';
            
            searchResults.forEach((stock, index) => {
                // Check if stock already exists
                const exists = userStocks.some(userStock => userStock.symbol.toLowerCase() === stock.symbol.toLowerCase());
                const disabledClass = exists ? ' style="opacity: 0.5; cursor: not-allowed;"' : '';
                const existsText = exists ? ' (Already added)' : '';
                
                html += `
                    <div class="stock-result${index === selectedResultIndex ? ' selected' : ''}" 
                         data-index="${index}" 
                         onclick="${exists ? '' : `selectStock(searchResults[${index}])`}"${disabledClass}>
                        <div class="stock-result-symbol">${stock.symbol}</div>
                        <div class="stock-result-name">${stock.name}${existsText}</div>
                    </div>
                `;
            });
            
            preview.innerHTML = html;
            preview.classList.add('visible');
        }

        function updateResultSelection() {
            const results = document.querySelectorAll('.stock-result');
            results.forEach((result, index) => {
                if (index === selectedResultIndex) {
                    result.classList.add('selected');
                    // Auto-select the stock when navigating with keyboard
                    if (searchResults[index]) {
                        selectStock(searchResults[index]);
                    }
                } else {
                    result.classList.remove('selected');
                }
            });
        }

        function selectStock(stockData) {
            // Check if stock already exists
            const exists = userStocks.some(stock => stock.symbol.toLowerCase() === stockData.symbol.toLowerCase());
            const addBtn = document.getElementById('addStockBtn');
            
            if (exists) {
                addBtn.disabled = true;
                currentStockData = null;
                return;
            }
            
            currentStockData = stockData;
            addBtn.disabled = false;
            
            // Update the selected state visually
            const results = document.querySelectorAll('.stock-result');
            results.forEach(result => result.classList.remove('selected'));
            
            const selectedIndex = searchResults.findIndex(s => s.symbol === stockData.symbol);
            if (selectedIndex >= 0) {
                selectedResultIndex = selectedIndex;
                results[selectedIndex]?.classList.add('selected');
            }
        }

        function addStock() {
            if (!currentStockData) return;
            
            const newStock = {
                symbol: currentStockData.symbol,
                name: currentStockData.name,
                id: currentStockData.symbol.toLowerCase(),
                class: getNextStockClass(),
                type: 'stock'
            };
            
            userStocks.push(newStock);
            saveUserStocks();
            
            // Don't reset form, just clear the current selection
            currentStockData = null;
            selectedResultIndex = -1;
            searchResults = [];
            
            const input = document.getElementById('stockInput');
            const preview = document.getElementById('stockPreview');
            const addBtn = document.getElementById('addStockBtn');
            
            // Clear input and preview, but keep form open
            input.value = '';
            preview.classList.remove('visible');
            preview.innerHTML = '';
            addBtn.disabled = true;
            
            // Focus back to input for next stock
            setTimeout(() => {
                input.focus();
            }, 100);
            
            // Update dashboard without destroying form
            updateDashboard();
        }

        function showRemoveConfirmation(symbol, name) {
            const modal = document.getElementById('confirmationModal');
            const text = document.getElementById('confirmationText');
            const confirmBtn = document.getElementById('confirmRemoveBtn');
            
            text.textContent = `Are you sure you want to remove ${name} (${symbol}) from your dashboard?`;
            
            confirmBtn.onclick = () => {
                removeStock(symbol);
                closeConfirmationModal();
            };
            
            modal.classList.add('visible');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('visible');
        }

        function removeStock(symbol) {
            userStocks = userStocks.filter(stock => stock.symbol !== symbol);
            saveUserStocks();
            
            // Force a fresh data fetch to ensure clean state
            setTimeout(() => {
                updateDashboard();
            }, 100);
        }

        async function fetchCryptoData() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,dogecoin,ripple,zcash&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true&include_market_cap=true');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const transformedData = [];
                    const mapping = {
                        'bitcoin': 'bitcoin',
                        'ethereum': 'ethereum', 
                        'solana': 'solana',
                        'dogecoin': 'dogecoin',
                        'ripple': 'ripple',
                        'zcash': 'zcash'
                    };
                    
                    Object.keys(mapping).forEach(key => {
                        if (data[key]) {
                            transformedData.push({
                                id: key,
                                current_price: data[key].usd,
                                price_change_percentage_24h: data[key].usd_24h_change || 0,
                                total_volume: data[key].usd_24h_vol || 0,
                                market_cap: data[key].usd_market_cap || 0
                            });
                        }
                    });
                    
                    return transformedData;
                }
                
                return generateCryptoMockData();
                
            } catch (error) {
                console.error('Error fetching crypto data:', error);
                return generateCryptoMockData();
            }
        }

        function generateCryptoMockData() {
            const baseData = {
                bitcoin: { price: 95000, change: 2.5, volume: 28000000000, mcap: 1800000000000 },
                ethereum: { price: 3400, change: -1.2, volume: 15000000000, mcap: 410000000000 },
                solana: { price: 140, change: 4.8, volume: 2500000000, mcap: 65000000000 },
                dogecoin: { price: 0.32, change: -0.8, volume: 1200000000, mcap: 47000000000 },
                ripple: { price: 2.1, change: 1.5, volume: 3200000000, mcap: 120000000000 },
                zcash: { price: 65, change: -2.1, volume: 180000000, mcap: 980000000 }
            };

            const variation = () => (Math.random() - 0.5) * 0.1;
            
            return Object.keys(baseData).map(id => ({
                id: id,
                current_price: baseData[id].price * (1 + variation()),
                price_change_percentage_24h: baseData[id].change + (Math.random() - 0.5) * 2,
                total_volume: baseData[id].volume * (1 + variation()),
                market_cap: baseData[id].mcap * (1 + variation())
            }));
        }

        async function fetchStockData() {
            const stockData = {};
            const symbols = userStocks.map(stock => stock.symbol);
            
            try {
                for (const symbol of symbols) {
                    try {
                        const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.c && data.c > 0) {
                                stockData[symbol] = {
                                    price: data.c,
                                    change: data.dp || 0,
                                    high: data.h || 0,
                                    low: data.l || 0
                                };
                            }
                        }
                    } catch (e) {
                        console.error(`Error fetching ${symbol}:`, e);
                    }
                }
                
            } catch (error) {
                console.error('Error fetching stock data:', error);
                throw error;
            }
            
            return stockData;
        }

        async function fetchTreasuryData() {
            const baseRate = 4.25;
            const variation = (Math.random() - 0.5) * 0.1;
            
            return {
                price: baseRate + variation,
                change: (Math.random() - 0.5) * 0.2,
                high: 0,
                low: 0
            };
        }

        async function fetchAllData() {
            const [cryptoData, stockData, treasuryData] = await Promise.all([
                fetchCryptoData(),
                fetchStockData(),
                fetchTreasuryData()
            ]);
            
            const allData = [...cryptoData];
            
            // Add treasury data
            allData.push({
                id: 'treasury-10y',
                current_price: treasuryData.price,
                price_change_percentage_24h: treasuryData.change,
                day_high: treasuryData.price,
                day_low: treasuryData.price
            });
            
            // Add user stock data
            userStocks.forEach(stock => {
                if (stockData[stock.symbol] && stockData[stock.symbol].price > 0) {
                    allData.push({
                        id: stock.id,
                        current_price: stockData[stock.symbol].price,
                        price_change_percentage_24h: stockData[stock.symbol].change,
                        day_high: stockData[stock.symbol].high,
                        day_low: stockData[stock.symbol].low
                    });
                }
            });
            
            return allData;
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleString()}`;
        }

        async function updateDashboard() {
            const cryptoGridElement = document.getElementById('cryptoGrid');
            const assetsGridElement = document.getElementById('assetsGrid');
            
            // Store add form state before update
            const addFormElement = document.getElementById('addStockForm');
            const wasFormVisible = addFormElement && addFormElement.classList.contains('visible');
            const inputValue = wasFormVisible ? document.getElementById('stockInput')?.value || '' : '';
            
            try {
                const data = await fetchAllData();
                
                let cryptoHtml = '';
                let assetsHtml = '';
                
                // Add crypto cards
                cryptos.forEach(crypto => {
                    const cryptoData = data.find(item => item.id === crypto.id);
                    if (cryptoData) {
                        cryptoHtml += createCryptoCard(crypto, cryptoData);
                    } else {
                        cryptoHtml += createCryptoCard(crypto, {
                            current_price: 0,
                            price_change_percentage_24h: 0,
                            total_volume: 0,
                            market_cap: 0
                        });
                    }
                });
                
                // Add treasury card (static)
                const treasuryData = data.find(item => item.id === treasuryAsset.id);
                if (treasuryData) {
                    assetsHtml += createAssetCard(treasuryAsset, treasuryData, false);
                }
                
                // Add user stock cards (dynamic) - with better error handling
                userStocks.forEach(stock => {
                    const stockData = data.find(item => item.id === stock.id);
                    if (stockData && stockData.current_price > 0) {
                        assetsHtml += createAssetCard(stock, stockData, true);
                    } else {
                        // If no data, show placeholder but don't show zero values
                        assetsHtml += createAssetCard(stock, {
                            current_price: 0,
                            price_change_percentage_24h: 0,
                            day_high: 0,
                            day_low: 0
                        }, true);
                    }
                });
                
                // Add the "Add Stock" card
                assetsHtml += createAddStockCard();
                
                cryptoGridElement.innerHTML = cryptoHtml;
                assetsGridElement.innerHTML = assetsHtml;
                updateLastUpdated();
                
                // Restore add form state if it was visible
                if (wasFormVisible) {
                    setTimeout(() => {
                        const form = document.getElementById('addStockForm');
                        const container = document.querySelector('.add-stock-container');
                        const input = document.getElementById('stockInput');
                        
                        if (form && container && input) {
                            form.classList.add('visible');
                            container.classList.add('expanded');
                            container.onclick = null;
                            addFormVisible = true;
                            
                            // Restore input value if there was one
                            if (inputValue) {
                                input.value = inputValue;
                            }
                            
                            input.focus();
                        }
                    }, 50);
                }
                
            } catch (error) {
                console.error('Dashboard update error:', error);
                cryptoGridElement.innerHTML = `
                    <div class="error">
                        <p>Unable to fetch financial data. Please check your internet connection and try again.</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Error: ${error.message}</p>
                    </div>
                `;
                assetsGridElement.innerHTML = '';
            }
        }

        // Initialize
        loadUserStocks();
        updateDashboard();
        setInterval(updateDashboard, 30000);

        // Close modal when clicking outside
        document.getElementById('confirmationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmationModal();
            }
        });
    </script>
</body>
</html>
